name: Build and Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number'
        required: true
        type: string
      message:
        description: 'Release message. â„¹ï¸Use "|||" for line breaks. â„¹ï¸Please use HTML tags,not Markdown'
        required: false
        type: string
        default: ''
      draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: true

jobs:
  check:
    name: Check code error
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Upgrade pip and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyflakes

      - name: Check
        id: check
        run: |
          pyflakes . > errors.txt || :
          if [ -s errors.txt ]; then
            echo "æœ‰é”™è¯¯"
            echo "should_build=false" >> $GITHUB_OUTPUT
            errors=$(cat errors.txt)
            echo "<h1>Check error!</h1>Find errors!Please edit.<br>ERRORS:<br><pre>$errors</pre>" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "æ— é”™è¯¯"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        if: ${{ steps.check.outputs.should_build == 'false' }}
        with:
          name: errors
          path: errors.txt

  build:
    needs: check
    name: Build Executables
    runs-on: ${{ matrix.os }}
    if: ${{ needs.check.outputs.should_build == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - name: 'winx64'
            os: 'windows-latest'
            arch: 'x64'
          - name: 'winx86'
            os: 'windows-latest'
            arch: 'x86'

          # Linux
          - name: 'linuxx64'
            os: 'ubuntu-latest'
            arch: 'x64'

          # MacOS
          - name: 'macosintel'
            os: 'macos-15-intel'
            arch: 'x64'
          - name: 'macosm'
            os: 'macos-latest'
            arch: 'arm64'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Set up Python 3.12
        if: matrix.name != 'linuxx86'
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          architecture: ${{ matrix.arch }}
  
      - name: Upgrade pip and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
  
      - name: Build executable for Windows
        if: matrix.os == 'windows-latest'
        run: |
          echo "=== å¼€å§‹æ„å»º ${{ matrix.name }} ==="
          pyinstaller --noconfirm --onefile --windowed --name "æ¶é­”è½®ç›˜_${{ github.event.inputs.version }}_${{ matrix.name }}.exe" main.py
          echo "=== æ„å»ºå®Œæˆ ==="

      - name: Build executable for Unix
        if: matrix.os != 'windows-latest'
        run: |
          echo "=== å¼€å§‹æ„å»º ${{ matrix.name }} ==="
          pyinstaller --noconfirm --onefile --windowed --name "æ¶é­”è½®ç›˜_${{ github.event.inputs.version }}_${{ matrix.name }}" main.py
          echo "=== æ„å»ºå®Œæˆ ==="
  
      - name: Generate SHA256 checksum for Windows
        if: matrix.os == 'windows-latest'
        run: |
          echo "=== ç”Ÿæˆ ${{ matrix.name }} çš„ SHA256 æ ¡éªŒç  ==="
          certutil -hashfile "dist/æ¶é­”è½®ç›˜_${{ github.event.inputs.version }}_${{ matrix.name }}.exe" SHA256 | findstr /v "CertUtil" | findstr /v ":" > "checksum_temp.txt"
          set /p CHECKSUM=<checksum_temp.txt
          echo "${{ matrix.name }}:%CHECKSUM%" > sha256_æ¶é­”è½®ç›˜_${{ github.event.inputs.version }}_${{ matrix.name }}.txt
          del checksum_temp.txt
          echo "===ç”Ÿæˆå®Œæˆ==="
        shell: cmd
  
      - name: Generate SHA256 checksum for Unix
        if: matrix.os != 'windows-latest'
        run: |
          echo "=== ç”Ÿæˆ ${{ matrix.name }} çš„ SHA256 æ ¡éªŒç  ==="
          shasum -a 256 "dist/æ¶é­”è½®ç›˜_${{ github.event.inputs.version }}_${{ matrix.name }}" | cut -d ' ' -f 1 > "checksum_temp.txt"
          CHECKSUM=$(cat "checksum_temp.txt")
          echo "${{ matrix.name }}:$CHECKSUM" > sha256_æ¶é­”è½®ç›˜_${{ github.event.inputs.version }}_${{ matrix.name }}.txt
          rm -f "checksum_temp.txt"
          echo "===ç”Ÿæˆå®Œæˆ==="
  
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: |
            dist/æ¶é­”è½®ç›˜_${{ github.event.inputs.version }}_${{ matrix.name }}*
            sha256_æ¶é­”è½®ç›˜_${{ github.event.inputs.version }}_${{ matrix.name }}.txt
          exclude: |
            *.app/**
            CodeResources
            Info.plist
            *.icns

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
  
      - name: Prepare Release Message
        id: prepare-message
        run: |
          INPUT_MESSAGE="${{ github.event.inputs.message }}"
          if [ -z "$INPUT_MESSAGE" ]; then
            FINAL_MESSAGE="Release ${{ github.event.inputs.version }}"
          else
            FINAL_MESSAGE=$(echo "$INPUT_MESSAGE" | sed 's/|||/<br>/g')
          fi
          
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "final_message<<$EOF" >> $GITHUB_OUTPUT
          echo "$FINAL_MESSAGE" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
  
      - name: Create Release Draft with Tag
        id: create-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body: ${{ steps.prepare-message.outputs.final_message }}
          draft: ${{ github.event.inputs.draft }}
          files: |
            ./artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
      - name: Add Release Link to Summary
        run: |
          if ${{ github.event.inputs.draft }}; then
            echo "<h1>ğŸš€ è‰ç¨¿ Releaseå·²å‘å¸ƒï¼</h1><a href='${{ steps.create-release.outputs.url }}'>ç‚¹æ­¤æŸ¥çœ‹</a><br>ç‰ˆæœ¬: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "<h1>ğŸš€ Releaseå·²å‘å¸ƒï¼</h1><a href='${{ steps.create-release.outputs.url }}'>ç‚¹æ­¤æŸ¥çœ‹</a><br>ç‰ˆæœ¬: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
